MMD-Facial-Morphing-Shader
==========================

MikuMikuDance for Unityの表情用シェーダーをちょっと組めないかな議事録．

==========================

# 検討

表情用シェーダーをどうしたものかアイディアを出してみる．

## シンプルに，表情ごとにテクスチャを使う

テクスチャの座標がそのまま頂点インデックスに対応している．
頂点ごとにモーフィングする量を書くことで，頂点座標 + (表情 x モーフ量)の形で表現する．

### 利点

非常に作りやすい．すぐに書けると思う．

### 問題点

モーフしない頂点のほうが多いので，無駄な情報が書き込まれてしまう．

## 参照している頂点と表情でテクスチャを分ける

参照している頂点用のテクスチャと，モーフ量を書いたテクスチャで分ける．
これにより，モーフしない頂点を除外できる．

参照している頂点用テクスチャは，最大値の場合，利用しない頂点とする．
(0～最大値 - 1)が，表情用のテクスチャ座標に対応する．
従って，参照している頂点用テクスチャの数値が1234の場合，
表情用テクスチャ座標における1234と対応している．
最大値の場合は使わない頂点ということになる．

### 利点
データ量が少なくなる．意外とそのまま実装できそう．

### 欠点
間違いなく面倒くさい．

==========================

# 実装

実装としては後者の参照している頂点と表情で分ける方式がベタだと思う．
あわよくば適当な研究会で発表できる内容だとも思う．

## 設計

設計は2種類に分ける．
シェーダのテンプレートとなる部分と，シェーダそのものを自動生成する部分．

###　シェーダーテンプレート

シェーダー用のテンプレートのメモ．

#### 定義

参照用のテクスチャをUtilizedMapと呼ぶ．表情用テクスチャをSkinnedMapと呼ぶ．表情の変化量をWeightと呼ぶ．頂点シェーダにより変化した後の頂点をSkinnedPositionと呼ぶ．また，個別の表情の変化量についてはSkinnedVectorと呼ぶ．

#### 概要

UtilizedMapには64bitで値が書き込まれる．
0x00000000から0xFFFFFFFEの値を取り，この値は表情用テクスチャの座標を表している．
また，0xFFFFFFFFのとき，表情として利用されない頂点となる．

SkinnedMapはARGB値が書き込まれる．
RGBがモーフ先の正規化済みベクトルを表し，アルファ値がその最大モーフ量となる．
当該の表情で使用されない場合，0x00000000となる．

Weightはfloat型で表される．
0.0から1.0までの値を取り，表情の変化量として表される．
従って，SkinnedVector = ベクトル x　モーフ量 x Weightで表情が表される．

SkinnedPositionは，全ての表情におけるSkinnedVectorの内積で表される．

#### 実装

